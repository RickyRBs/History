<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cíqì Chronicles - Chinese Porcelain Timeline</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- 3. Babel (For running React code in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Import Map: Defines exact versions for all libraries -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "vite": "https://esm.sh/vite@^7.2.7",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
    
    <!-- Tailwind Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'cobalt': '#0047AB',
              'cobalt-dark': '#003380',
              'celadon': '#A6C9B3',
              'celadon-light': '#E0F0E5',
              'china-red': '#C41E3A',
              'paper': '#F9F7F2',
              'ink': '#2C2C2C'
            },
            fontFamily: {
              serif: ['"Playfair Display"', 'serif'],
              sans: ['"Lato"', 'sans-serif'],
            }
          }
        }
      }
      
      // Shim process.env for libraries that might expect it
      window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <style>
      body {
        background-color: #F9F7F2;
        color: #2C2C2C;
        background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
        background-size: 24px 24px;
        margin: 0;
      }
      ::-webkit-scrollbar { width: 10px; }
      ::-webkit-scrollbar-track { background: #F9F7F2; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid #F9F7F2; }
      ::-webkit-scrollbar-thumb:hover { background: #0047AB; }
      ::selection { background-color: #E0F0E5; color: #0047AB; }
      
      .perspective-1000 { perspective: 1200px; }
      .preserve-3d { transform-style: preserve-3d; }
      .backface-hidden { backface-visibility: visible; }
      
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-type="module">
        // Imports match keys in the importmap above
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Languages, Plus, RotateCcw, Share2, Check, Tag, Pencil, Trash2, Sparkles, Loader2, X, Upload, Link as LinkIcon, Image as ImageIcon } from 'lucide-react';
        import { GoogleGenAI, Type } from "@google/genai";

        // --- TYPES & CONSTANTS ---

        const EventType = {
          COURSE: 'COURSE',
          PERSONAL: 'PERSONAL',
          HISTORICAL: 'HISTORICAL'
        };

        const INITIAL_EVENTS = [
          {
            id: 'neolithic-yangshao',
            title: 'Yangshao Culture: Painted Pottery',
            titleZh: '新石器时代：仰韶彩陶',
            year: 'c. 5000–3000 BC',
            yearZh: '约公元前 5000–3000 年',
            sortYear: -5000,
            description: 'Before true porcelain, the Yangshao culture along the Yellow River created distinct red earthenware. This basin features a fish design, painted in black slip on a reddish body. It represents the "Painted Pottery" phase.',
            descriptionZh: '在真正的瓷器诞生之前，黄河流域的仰韶文化创造了独特的红陶。这个陶盆绘有人面鱼纹，是在红色陶体上用黑色泥浆绘制的。',
            type: EventType.HISTORICAL,
            tags: ['Neolithic', 'Earthenware', 'Painted Pottery', 'Yangshao'],
            tagsZh: ['新石器时代', '陶器', '彩陶', '仰韶文化'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Painted_pottery_basin_with_human_face_and_fish_designs.jpg/1280px-Painted_pottery_basin_with_human_face_and_fish_designs.jpg'
          },
          {
            id: 'shang-proto',
            title: 'Shang Dynasty: Proto-Porcelain',
            titleZh: '商代：原始瓷尊',
            year: 'c. 1600–1046 BC',
            yearZh: '约公元前 1600–1046 年',
            sortYear: -1600,
            description: 'The Shang dynasty saw the birth of "Proto-porcelain" (yuanshi ci). Made of kaolin-rich clay and fired at high temperatures with a lime-based glaze.',
            descriptionZh: '商代见证了“原始瓷”（yuanshi ci）的诞生。由富含高岭土的粘土制成，并在高温下使用石灰釉烧制。',
            type: EventType.COURSE,
            tags: ['Shang Dynasty', 'Proto-porcelain', 'Kaolin', 'High-fired'],
            tagsZh: ['商代', '原始瓷', '高岭土', '高温烧制'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Shang_Proto-porcelain_Zun.jpg/800px-Shang_Proto-porcelain_Zun.jpg'
          },
          {
            id: 'han-greenware',
            title: 'Han Dynasty: Greenware Tower',
            titleZh: '东汉：绿釉陶楼',
            year: '206 BC – 220 AD',
            yearZh: '公元前 206 年 – 公元 220 年',
            sortYear: -206,
            description: 'During the Han, green-glazed stoneware became widespread. This architectural model served as "mingqi" (spirit goods) for the afterlife.',
            descriptionZh: '汉代时期，绿釉陶器变得普遍。这座陶楼模型作为“明器”（随葬品），旨在为死者在来世提供住所。',
            type: EventType.HISTORICAL,
            tags: ['Han Dynasty', 'Celadon Origins', 'Mingqi', 'Burial Goods'],
            tagsZh: ['汉代', '青瓷起源', '明器', '随葬品'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Han_glazed_pottery_tower.JPG/800px-Han_glazed_pottery_tower.JPG'
          },
          {
            id: 'tang-sancai',
            title: 'Tang Dynasty: Sancai Camel',
            titleZh: '唐代：三彩载乐驼',
            year: '618–907 AD',
            yearZh: '公元 618–907 年',
            sortYear: 618,
            description: 'The cosmopolitan Tang Dynasty is epitomized by "Sancai" (Three-Color) wares. The low-fired lead glazes create signature amber, green, and cream splashes.',
            descriptionZh: '国际化的唐代以“唐三彩”为代表。低温铅釉形成了标志性的琥珀色、绿色和奶油色斑块。',
            type: EventType.COURSE,
            tags: ['Tang Dynasty', 'Sancai', 'Silk Road', 'Polychrome'],
            tagsZh: ['唐代', '唐三彩', '丝绸之路', '多色釉'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Sancai_camel_musicians_NMB_Bern_1993.200.jpg/1024px-Sancai_camel_musicians_NMB_Bern_1993.200.jpg'
          },
          {
            id: 'tang-xing',
            title: 'Tang Dynasty: Xing White Ware',
            titleZh: '唐代：邢窑白瓷',
            year: 'c. 7th–9th Century',
            yearZh: '约 7–9 世纪',
            sortYear: 700,
            description: 'Celebrated by tea master Lu Yu as "like silver and snow". This high-fired white porcelain set the standard for purity.',
            descriptionZh: '茶圣陆羽赞誉其“类银”、“类雪”。这种高温白瓷确立了纯净的标准。',
            type: EventType.HISTORICAL,
            tags: ['Tang Dynasty', 'White Ware', 'Xing Kiln', 'Tea Culture'],
            tagsZh: ['唐代', '白瓷', '邢窑', '茶文化'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Xing_ware_ewer_Tang_Dynasty.jpg/800px-Xing_ware_ewer_Tang_Dynasty.jpg'
          },
          {
            id: 'song-ru',
            title: 'Northern Song: Ru Ware',
            titleZh: '北宋：汝窑天青釉',
            year: '1086–1125 AD',
            yearZh: '公元 1086–1125 年',
            sortYear: 1086,
            description: 'The pinnacle of Chinese ceramics. Ru ware is famous for its rare "sky-blue after rain" glaze and subtle crazing.',
            descriptionZh: '中国陶瓷的巅峰。汝窑以其罕见的“雨过天青”釉色和微妙的开片而闻名。',
            type: EventType.COURSE,
            tags: ['Northern Song', 'Ru Ware', 'Imperial', 'Monochrome'],
            tagsZh: ['北宋', '汝窑', '宫廷御用', '单色釉'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Ru_ware_brush_washer_Palace_Museum.jpg/1024px-Ru_ware_brush_washer_Palace_Museum.jpg'
          },
          {
            id: 'song-ding',
            title: 'Song Dynasty: Ding Ware',
            titleZh: '北宋：定窑白釉',
            year: '960–1279 AD',
            yearZh: '公元 960–1279 年',
            sortYear: 1100,
            description: 'Ding ware is known for its warm, ivory tone and "teardrop" glaze runs, often featuring incised floral decorations.',
            descriptionZh: '定窑以温暖的象牙色调和“泪痕”状釉流而闻名，通常饰有刻花花卉纹样。',
            type: EventType.COURSE,
            tags: ['Song Dynasty', 'Ding Ware', 'White Porcelain', 'Incised'],
            tagsZh: ['宋代', '定窑', '白瓷', '刻花'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Ding_ware_dish_with_daylily.jpg/800px-Ding_ware_dish_with_daylily.jpg'
          },
          {
            id: 'song-jun',
            title: 'Song Dynasty: Jun Ware',
            titleZh: '宋代：钧窑玫瑰紫釉',
            year: 'c. 1100–1300 AD',
            yearZh: '约公元 1100–1300 年',
            sortYear: 1150,
            description: 'Jun ware is famed for its thick, opalescent blue glaze, often splashed with copper oxide to create striking purple or red patches.',
            descriptionZh: '钧窑以其厚重、乳光质感的蓝色釉而闻名，常泼洒氧化铜以形成醒目的紫色或红色斑块。',
            type: EventType.HISTORICAL,
            tags: ['Song Dynasty', 'Jun Ware', 'Purple Splashes', 'Opalescent'],
            tagsZh: ['宋代', '钧窑', '紫斑', '乳光'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Official_Jun_ware_rose-purple_glazed_flowerpot_stand_with_inscription_of_Studio_of_Utilizing_Time%2C_Yuan_or_early_Ming_dynasty%2C_Jun_kilns%2C_stoneware_-_The_David_Collection_-_Copenhagen_-_DSC04868.JPG/800px-Official_Jun_ware_rose-purple_glazed_flowerpot_stand_with_inscription_of_Studio_of_Utilizing_Time%2C_Yuan_or_early_Ming_dynasty%2C_Jun_kilns%2C_stoneware_-_The_David_Collection_-_Copenhagen_-_DSC04868.JPG'
          },
          {
            id: 'song-longquan',
            title: 'Southern Song: Longquan',
            titleZh: '南宋：龙泉窑青瓷',
            year: '1127–1279 AD',
            yearZh: '公元 1127–1279 年',
            sortYear: 1200,
            description: 'Longquan kilns produced massive amounts of greenware with a thick, unctuous plum-green glaze that mimics jade.',
            descriptionZh: '龙泉窑生产了大量青瓷，具有厚重、温润、模仿玉石的梅子青釉。',
            type: EventType.HISTORICAL,
            tags: ['Southern Song', 'Celadon', 'Longquan', 'Jade-like'],
            tagsZh: ['南宋', '青瓷', '龙泉窑', '类玉'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Longquan_celadon_vase_Song_MET.jpg/800px-Longquan_celadon_vase_Song_MET.jpg'
          },
          {
            id: 'yuan-blue-white',
            title: 'Yuan Dynasty: The David Vases',
            titleZh: '元代：大维德青花瓶',
            year: '1351 AD',
            yearZh: '公元 1351 年',
            sortYear: 1351,
            description: 'The most famous blue-and-white porcelain in the world. They prove Jingdezhen mastered imported Persian cobalt by 1351.',
            descriptionZh: '世界上最著名的青花瓷。它们证明景德镇在1351年已掌握了进口波斯钴料的使用。',
            type: EventType.COURSE,
            tags: ['Yuan Dynasty', 'Blue and White', 'Cobalt', 'David Vases'],
            tagsZh: ['元代', '青花瓷', '钴料', '大维德瓶'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/The_David_Vases%2C_British_Museum.jpg/800px-The_David_Vases%2C_British_Museum.jpg'
          },
          {
            id: 'ming-chenghua',
            title: 'Ming Dynasty: Chicken Cup',
            titleZh: '明成化：斗彩鸡缸杯',
            year: '1464–1487 AD',
            yearZh: '公元 1464–1487 年',
            sortYear: 1470,
            description: 'The "Chicken Cup" utilizes the Doucai (Contending Colors) technique: blue outlines under glaze, filled with enamels over glaze.',
            descriptionZh: '“鸡缸杯”运用了斗彩技法：釉下青花勾勒轮廓，釉上填彩。',
            type: EventType.COURSE,
            tags: ['Ming Dynasty', 'Doucai', 'Chenghua', 'Imperial'],
            tagsZh: ['明代', '斗彩', '成化', '御用'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Chicken_Cup_Chenghua.jpg/800px-Chicken_Cup_Chenghua.jpg'
          },
          {
            id: 'ming-wucai',
            title: 'Ming Dynasty: Wucai Jar',
            titleZh: '明万历：五彩龙纹罐',
            year: '1573–1620 AD',
            yearZh: '公元 1573–1620 年',
            sortYear: 1580,
            description: 'Wucai (Five Color) ware is known for its bold, vibrant palette. Unlike Doucai, it uses blue as a filling color rather than just an outline.',
            descriptionZh: '五彩瓷以其大胆、鲜艳的色彩而闻名。与斗彩不同，它使用蓝色作为填充色，而不仅仅是轮廓。',
            type: EventType.HISTORICAL,
            tags: ['Ming Dynasty', 'Wucai', 'Wanli', 'Polychrome'],
            tagsZh: ['明代', '五彩', '万历', '多色釉'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Wucai_Jar_Wanli_Ming.jpg/800px-Wucai_Jar_Wanli_Ming.jpg'
          },
          {
            id: 'ming-dehua',
            title: 'Late Ming: Dehua Blanc de Chine',
            titleZh: '明代：德化白瓷观音',
            year: 'c. 1600–1644 AD',
            yearZh: '约公元 1600–1644 年',
            sortYear: 1600,
            description: 'Unique for its sugary white body and sculptural form. Dehua porcelain relied entirely on form rather than painted decoration.',
            descriptionZh: '以其如糖般的白色胎体和雕塑造型而独树一帜。德化瓷完全依靠造型而非彩绘装饰。',
            type: EventType.HISTORICAL,
            tags: ['Ming Dynasty', 'Dehua', 'Blanc de Chine', 'Sculpture'],
            tagsZh: ['明代', '德化', '中国白', '雕塑'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/Dehua_Guanyin_Ming.jpg/800px-Dehua_Guanyin_Ming.jpg'
          },
          {
            id: 'qing-peachbloom',
            title: 'Qing Dynasty: Peach Bloom',
            titleZh: '清康熙：豇豆红釉',
            year: '1662–1722 AD',
            yearZh: '公元 1662–1722 年',
            sortYear: 1680,
            description: 'A copper-red glaze specially devised for the scholar\'s table. The mottling resembles the skin of a ripening peach or cowpea.',
            descriptionZh: '一种专为文房案头设计的铜红釉。其斑驳的色彩类似成熟桃子的表皮或豇豆。',
            type: EventType.HISTORICAL,
            tags: ['Qing Dynasty', 'Kangxi', 'Peach Bloom', 'Scholar'],
            tagsZh: ['清代', '康熙', '豇豆红', '文房'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Peach-bloom_glazed_water_pot_-_Palace_Museum_Beijing.jpg/800px-Peach-bloom_glazed_water_pot_-_Palace_Museum_Beijing.jpg'
          },
          {
            id: 'qing-famille-rose',
            title: 'Qing Dynasty: Famille Rose',
            titleZh: '清乾隆：粉彩花卉瓶',
            year: 'c. 1735–1796 AD',
            yearZh: '约公元 1735–1796 年',
            sortYear: 1750,
            description: 'This palette introduced opaque whites and pinks, allowing for shading and realistic floral depictions akin to oil painting.',
            descriptionZh: '这种色调引入了不透明的白色和粉红色，使得类似油画的阴影和写实花卉描绘成为可能。',
            type: EventType.COURSE,
            tags: ['Qing Dynasty', 'Famille Rose', 'Enamel', 'Qianlong'],
            tagsZh: ['清代', '粉彩', '珐琅', '乾隆'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Famille_rose_vase_Qianlong.jpg/800px-Famille_rose_vase_Qianlong.jpg'
          },
          {
            id: 'personal-dragon-kiln',
            title: 'Curiosity: The Dragon Kiln',
            titleZh: '设计趣闻：龙窑',
            year: 'Invention c. 200 AD',
            yearZh: '约公元 200 年发明',
            sortYear: 200,
            description: 'Personal Interest Note: I found the engineering of the "Dragon Kiln" (Longyao) fascinating. Built along hillsides to create a natural draft, allowing temperatures to reach 1300°C for the first time.',
            descriptionZh: '个人兴趣笔记：我觉得“龙窑”的工程设计非常迷人。依山而建以形成自然抽力，使温度首次达到 1300°C。',
            type: EventType.PERSONAL,
            tags: ['Engineering', 'Kiln Technology', 'Design Curiosity', 'Personal'],
            tagsZh: ['工程学', '窑炉技术', '设计趣闻', '个人'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Dragon_Kiln_Nanfeng.jpg/800px-Dragon_Kiln_Nanfeng.jpg'
          },
          {
            id: 'personal-grandmother',
            title: 'Grandmother\'s Yixing Teapot',
            titleZh: '家族传承：祖母的紫砂壶',
            year: '1985',
            yearZh: '1985 年',
            sortYear: 1985,
            description: 'A personal artifact. A "zisha" (purple sand) teapot from Yixing. Unglazed, it absorbs tea oils, developing a patina over decades.',
            descriptionZh: '一件个人物品。来自宜兴的“紫砂”茶壶。无釉，吸收茶油，经过数十年形成包浆。',
            type: EventType.PERSONAL,
            tags: ['Family History', 'Yixing', 'Tea Culture', 'Personal'],
            tagsZh: ['家族历史', '宜兴', '茶文化', '个人'],
            imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Yixing_Teapot.jpg/800px-Yixing_Teapot.jpg'
          }
        ];

        // --- GEMINI AI SERVICE (Client Side) ---
        // Since we are running in the browser without .env, we will ask the user for their key if they want to use AI.
        
        let userApiKey = localStorage.getItem('ciqi-api-key') || '';

        const enhanceEntry = async (title, year, currentNotes) => {
          if (!userApiKey) {
            const key = prompt("To use the AI Historian, please enter your Google Gemini API Key:", "");
            if (key) {
              userApiKey = key;
              localStorage.setItem('ciqi-api-key', key);
            } else {
              return null;
            }
          }

          try {
            const ai = new GoogleGenAI({ apiKey: userApiKey });
            const schema = {
                type: Type.OBJECT,
                properties: {
                  expandedDescription: { type: Type.STRING },
                  historicalContext: { type: Type.STRING },
                  suggestedTags: { type: Type.ARRAY, items: { type: Type.STRING } }
                },
                required: ["expandedDescription", "historicalContext", "suggestedTags"],
            };

            const promptText = `
              The user is creating a timeline of Chinese Porcelain (Cíqì).
              Topic: ${title}
              Time Period: ${year}
              User Notes: ${currentNotes}

              Please act as an expert art historian. Expand on the user's notes, provide historical context, and suggest tags.
            `;

            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: promptText,
              config: {
                responseMimeType: "application/json",
                responseSchema: schema
              }
            });

            return JSON.parse(response.text);
          } catch (error) {
            console.error("Gemini API Error:", error);
            if(error.toString().includes("403") || error.toString().includes("API key")) {
               alert("Invalid API Key. Please try again.");
               localStorage.removeItem('ciqi-api-key');
               userApiKey = '';
            }
            return null;
          }
        };


        // --- COMPONENTS ---

        const EventCard = ({ event, align, onDelete, onEdit, language }) => {
          const isCourse = event.type === EventType.COURSE;
          const isPersonal = event.type === EventType.PERSONAL;
          
          const borderColor = isCourse ? 'border-cobalt' : isPersonal ? 'border-china-red' : 'border-gray-400';
          const typeLabel = language === 'zh' 
             ? (isCourse ? '课程资料' : isPersonal ? '私人档案' : '历史背景')
             : (isCourse ? 'Lecture / Recitation' : isPersonal ? 'Personal Interest' : 'Historical Context');
          const accentColor = isCourse ? 'text-cobalt' : isPersonal ? 'text-china-red' : 'text-gray-500';

          const title = language === 'zh' ? (event.titleZh || event.title) : event.title;
          const year = language === 'zh' ? (event.yearZh || event.year) : event.year;
          const description = language === 'zh' ? (event.descriptionZh || event.description) : event.description;
          const tags = language === 'zh' ? (event.tagsZh || event.tags) : event.tags;

          return (
            <div className={`relative w-full md:w-[calc(50%-40px)] ${align === 'right' ? 'md:ml-auto' : 'md:mr-auto'}`}>
              {/* Connector Dot */}
              <div className={`absolute top-8 w-5 h-5 rounded-full border-4 border-white shadow-md z-10 hidden md:block transition-transform hover:scale-125
                ${isCourse ? 'bg-cobalt' : isPersonal ? 'bg-china-red' : 'bg-gray-400'}
                ${align === 'right' ? '-left-[50px]' : '-right-[50px]'}
              `}></div>

              {/* Connector Dot (Mobile) */}
              <div className={`absolute left-[20px] top-8 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10 md:hidden
                ${isCourse ? 'bg-cobalt' : isPersonal ? 'bg-china-red' : 'bg-gray-400'}
              `}></div>

              <div className={`
                ml-12 md:ml-0 bg-white rounded-xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] 
                border-t-4 ${borderColor}
                hover:shadow-[0_15px_30px_-4px_rgba(0,0,0,0.15)] hover:-translate-y-1 
                transition-all duration-300 group overflow-hidden
              `}>
                <div className="md:flex h-full">
                  {event.imageUrl && (
                    <div className="md:w-1/3 h-48 md:h-auto relative overflow-hidden bg-gray-100">
                       <img src={event.imageUrl} alt={title} className="w-full h-full object-cover absolute inset-0 transition-transform duration-700 group-hover:scale-110" />
                       <div className="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent md:bg-gradient-to-r"></div>
                    </div>
                  )}

                  <div className={`p-8 ${event.imageUrl ? 'md:w-2/3' : 'w-full'}`}>
                    <div className="flex justify-between items-start mb-2">
                      <span className={`text-xs font-bold uppercase tracking-widest ${accentColor}`}>{typeLabel}</span>
                      <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onClick={() => onEdit(event)} className="text-gray-400 hover:text-cobalt p-1"><Pencil size={14} /></button>
                        <button onClick={() => onDelete(event.id)} className="text-gray-400 hover:text-red-500 p-1"><Trash2 size={14} /></button>
                      </div>
                    </div>

                    <h3 className="font-serif text-3xl text-ink font-bold mb-1 leading-tight">{title}</h3>
                    <p className="text-sm font-semibold text-gray-400 mb-6 font-mono tracking-wide">{year}</p>

                    <div className="prose prose-sm max-w-none mb-6">
                      <p className="text-gray-600 leading-relaxed whitespace-pre-wrap font-sans text-base">{description}</p>
                    </div>

                    {tags && tags.length > 0 && (
                      <div className="flex flex-wrap gap-2 pt-4 border-t border-gray-100">
                        {tags.map(tag => (
                          <span key={tag} className="flex items-center text-xs text-gray-500 px-2 py-1 rounded bg-gray-50 border border-gray-100 transition-colors hover:bg-gray-100 hover:text-cobalt">
                            <Tag size={10} className="mr-1" />
                            {tag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const TimeSpinner = ({ events, onSelectEvent, language }) => {
          const count = events.length;
          const anglePerItem = 360 / count;
          const radius = 380; 
          const [scrollPos, setScrollPos] = useState(0);
          
          const rotation = -scrollPos * anglePerItem;
          const activeIndex = Math.round(scrollPos) % count;
          const activeEvent = events[activeIndex];

          const getTitle = (e) => language === 'zh' ? (e?.titleZh || e?.title) : e?.title;
          const getYear = (e) => language === 'zh' ? (e?.yearZh || e?.year) : e?.year;

          return (
            <div className="w-full h-[85vh] flex flex-col items-center justify-center relative overflow-hidden bg-[#F9F7F2]">
              <div className="absolute inset-0 pointer-events-none">
                 <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Fan_Kuan_-_Travelers_Among_Mountains_and_Streams_-_Google_Art_Project.jpg/1280px-Fan_Kuan_-_Travelers_Among_Mountains_and_Streams_-_Google_Art_Project.jpg"
                    className="absolute inset-0 w-full h-full object-cover opacity-[0.08] mix-blend-multiply scale-110 blur-[1px]" />
                 <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-cobalt/5 rounded-full blur-3xl"></div>
                 <div className="absolute top-0 w-full h-32 bg-gradient-to-b from-[#F9F7F2] via-[#F9F7F2]/80 to-transparent z-10"></div>
                 <div className="absolute bottom-0 w-full h-32 bg-gradient-to-t from-[#F9F7F2] via-[#F9F7F2]/80 to-transparent z-10"></div>
              </div>

              <div className="relative w-full max-w-4xl h-[500px] flex items-center justify-center perspective-1000 z-10">
                <div className="relative w-[240px] h-[360px] preserve-3d transition-transform duration-75 ease-out will-change-transform"
                  style={{ transform: `rotateY(${rotation}deg)` }}>
                  {events.map((event, index) => {
                    const angle = index * anglePerItem;
                    const isActive = activeIndex === index;
                    return (
                      <div key={event.id} className="absolute top-0 left-0 w-full h-full backface-hidden flex flex-col items-center justify-center bg-transparent"
                        style={{ transform: `rotateY(${angle}deg) translateZ(${radius}px)` }}>
                        <div className={`relative w-full h-full rounded-2xl overflow-hidden border shadow-2xl transition-all duration-500 cursor-pointer bg-white group
                            ${isActive ? 'border-cobalt scale-110 shadow-cobalt/30 ring-4 ring-cobalt/20 grayscale-0' : 'border-gray-200 opacity-60 grayscale scale-90'}
                          `} onClick={() => onSelectEvent(event.id)}>
                          {event.imageUrl ? (
                            <img src={event.imageUrl} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" />
                          ) : (
                            <div className="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400">No Image</div>
                          )}
                          <div className="absolute inset-2 border border-white/40 rounded-xl pointer-events-none z-10"></div>
                          <div className="absolute inset-0 bg-gradient-to-tr from-white/30 to-transparent pointer-events-none z-20"></div>
                        </div>
                        <div className="absolute -bottom-24 w-full h-full opacity-30 transform scale-y-[-1] blur-sm"
                             style={{ maskImage: 'linear-gradient(to bottom, rgba(0,0,0,1), transparent)', WebkitMaskImage: 'linear-gradient(to bottom, rgba(0,0,0,1), transparent)' }}>
                           {event.imageUrl && <img src={event.imageUrl} className="w-full h-full object-cover rounded-2xl" />}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="absolute top-[10%] text-center z-20 pointer-events-none px-4 select-none w-full">
                <h2 className="text-cobalt text-base md:text-lg font-bold tracking-[0.5em] uppercase mb-4 font-sans">{getYear(activeEvent)}</h2>
                <h1 className="text-5xl md:text-6xl font-serif font-bold text-ink drop-shadow-sm">{getTitle(activeEvent)?.split('：')[0].split(':')[0]}</h1>
              </div>

              <div className="absolute bottom-16 w-full flex flex-col items-center z-30 px-8 md:px-0">
                <input type="range" min={0} max={count - 1} step={0.01} value={scrollPos}
                  onChange={(e) => setScrollPos(parseFloat(e.target.value))}
                  className="w-full max-w-xl h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-cobalt hover:accent-cobalt-dark transition-all" />
                <p className="mt-4 text-xs text-gray-400 font-mono uppercase tracking-widest">{language === 'zh' ? '拖动时间轴' : 'Drag to Rotate History'}</p>
              </div>
            </div>
          );
        };

        const EventEditor = ({ isOpen, onClose, onSave, initialData }) => {
          const [title, setTitle] = useState('');
          const [year, setYear] = useState('');
          const [sortYear, setSortYear] = useState(0);
          const [description, setDescription] = useState('');
          const [type, setType] = useState(EventType.COURSE);
          const [imageUrl, setImageUrl] = useState('');
          const [isEnhancing, setIsEnhancing] = useState(false);
          const fileInputRef = useRef(null);

          useEffect(() => {
            if (initialData) {
              setTitle(initialData.title);
              setYear(initialData.year);
              setSortYear(initialData.sortYear);
              setDescription(initialData.description);
              setType(initialData.type);
              setImageUrl(initialData.imageUrl || '');
            } else {
              setTitle(''); setYear(''); setSortYear(0); setDescription(''); setType(EventType.COURSE); setImageUrl('');
            }
          }, [initialData, isOpen]);

          const handleEnhance = async () => {
            if (!title) return;
            setIsEnhancing(true);
            try {
              const result = await enhanceEntry(title, year, description);
              if (result) {
                const newDesc = `${description ? description + '\n\n' : ''}--- AI HISTORIAN CONTEXT ---\n${result.expandedDescription}\n\nHistorical Context: ${result.historicalContext}`;
                setDescription(newDesc);
              }
            } catch (e) { console.error(e); } finally { setIsEnhancing(false); }
          };

          const handleFileChange = (e) => {
            const file = e.target.files?.[0];
            if (file) {
              const reader = new FileReader();
              reader.onloadend = () => setImageUrl(reader.result);
              reader.readAsDataURL(file);
            }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            onSave({
              id: initialData ? initialData.id : Date.now().toString(),
              title, titleZh: title,
              year, yearZh: year,
              sortYear,
              description, descriptionZh: description,
              type,
              tags: initialData?.tags || [], tagsZh: initialData?.tagsZh || [],
              imageUrl: imageUrl || (!initialData ? `https://picsum.photos/seed/${Date.now()}/400/300` : '') 
            });
          };

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                <div className="flex justify-between items-center p-6 border-b border-gray-100">
                  <h2 className="text-2xl font-serif text-cobalt font-bold">{initialData ? 'Edit Entry' : 'Add New Entry'}</h2>
                  <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
                </div>
                <form onSubmit={handleSubmit} className="p-6 overflow-y-auto flex-1 space-y-4">
                  <div>
                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Category</label>
                    <div className="flex gap-2">
                       {[EventType.COURSE, EventType.PERSONAL, EventType.HISTORICAL].map(t => (
                         <button key={t} type="button" onClick={() => setType(t)} 
                            className={`flex-1 py-2 px-1 text-center text-xs rounded border ${type === t ? 'bg-cobalt text-white' : 'bg-white text-gray-600'}`}>
                            {t}
                         </button>
                       ))}
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                    <input type="text" required value={title} onChange={(e) => setTitle(e.target.value)} className="w-full p-3 border rounded" />
                  </div>
                  <div className="flex gap-4">
                    <div className="flex-1">
                      <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Year</label>
                      <input type="text" required value={year} onChange={(e) => setYear(e.target.value)} className="w-full p-3 border rounded" />
                    </div>
                    <div className="w-1/3">
                      <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Sort Year</label>
                      <input type="number" required value={sortYear} onChange={(e) => setSortYear(parseInt(e.target.value))} className="w-full p-3 border rounded" />
                    </div>
                  </div>
                  <div>
                     <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Image</label>
                     <div className="flex gap-2">
                        <input type="text" value={imageUrl} onChange={(e) => setImageUrl(e.target.value)} placeholder="Image URL..." className="flex-1 p-2 border rounded" />
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                        <button type="button" onClick={() => fileInputRef.current?.click()} className="p-2 border rounded hover:bg-gray-100"><Upload size={20} /></button>
                     </div>
                     {imageUrl && <img src={imageUrl} className="mt-2 h-20 object-contain border rounded" />}
                  </div>
                  <div>
                    <div className="flex justify-between items-center mb-1">
                      <label className="block text-xs font-bold text-gray-500 uppercase">Description</label>
                      <button type="button" onClick={handleEnhance} disabled={isEnhancing || !title} className="flex items-center text-xs text-cobalt hover:text-cobalt-dark">
                        {isEnhancing ? <Loader2 className="animate-spin mr-1" size={12} /> : <Sparkles className="mr-1" size={12} />} Ask AI
                      </button>
                    </div>
                    <textarea rows={6} value={description} onChange={(e) => setDescription(e.target.value)} className="w-full p-3 border rounded resize-none"></textarea>
                  </div>
                </form>
                <div className="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                  <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600">Cancel</button>
                  <button onClick={handleSubmit} className="px-6 py-2 bg-cobalt text-white rounded">Save Entry</button>
                </div>
              </div>
            </div>
          );
        };

        // --- MAIN APP ---

        function App() {
          const [events, setEvents] = useState(() => {
            const params = new URLSearchParams(window.location.search);
            const shared = params.get('data');
            if (shared) {
               try { return JSON.parse(atob(shared)); } catch (e) {}
            }
            try {
               const saved = localStorage.getItem('ciqi-timeline-data');
               if (saved) return JSON.parse(saved);
            } catch (e) {}
            return INITIAL_EVENTS;
          });

          const [language, setLanguage] = useState('zh');
          const [isEditorOpen, setIsEditorOpen] = useState(false);
          const [editingEvent, setEditingEvent] = useState(null);
          const [showCopied, setShowCopied] = useState(false);

          useEffect(() => {
             localStorage.setItem('ciqi-timeline-data', JSON.stringify(events));
          }, [events]);

          const sortedEvents = useMemo(() => [...events].sort((a, b) => a.sortYear - b.sortYear), [events]);

          const scrollToEvent = (id) => {
            document.getElementById(`event-${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          };

          const handleSaveEvent = (event) => {
            setEvents(prev => {
              const exists = prev.find(e => e.id === event.id);
              return exists ? prev.map(e => e.id === event.id ? event : e) : [...prev, event];
            });
            setIsEditorOpen(false); setEditingEvent(null);
          };

          const handleDeleteEvent = (id) => {
             if (confirm('Delete this event?')) setEvents(prev => prev.filter(e => e.id !== id));
          };

          const generateShareLink = () => {
             const cleanEvents = events.map(e => (e.imageUrl?.startsWith('data:') ? { ...e, imageUrl: '' } : e));
             const url = `${window.location.origin}${window.location.pathname}?data=${btoa(JSON.stringify(cleanEvents))}`;
             navigator.clipboard.writeText(url).then(() => {
                setShowCopied(true); setTimeout(() => setShowCopied(false), 3000);
             });
          };

          return (
            <div className="min-h-screen bg-paper font-sans text-ink pb-20 animate-fade-in">
              <div className="fixed top-6 right-6 z-50 flex gap-4">
                <button onClick={generateShareLink} className="bg-white/80 p-3 rounded-full shadow-md text-cobalt relative group">
                  {showCopied ? <Check size={24} className="text-green-600" /> : <Share2 size={24} />}
                  <span className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-ink text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap pointer-events-none">Share</span>
                </button>
                <button onClick={() => { setEditingEvent(null); setIsEditorOpen(true); }} className="bg-cobalt text-white p-3 rounded-full shadow-lg hover:scale-105 flex items-center justify-center group">
                  <Plus size={24} />
                </button>
                <button onClick={() => setLanguage(l => l === 'zh' ? 'en' : 'zh')} className="bg-white/80 p-3 rounded-full shadow-md text-cobalt"><Languages size={24} /></button>
              </div>

              <TimeSpinner events={sortedEvents} onSelectEvent={scrollToEvent} language={language} />

              <main className="max-w-6xl mx-auto px-4 py-12 md:py-20">
                <div className="relative">
                  <div className="absolute left-1/2 transform -translate-x-1/2 h-full w-0.5 bg-gradient-to-b from-transparent via-gray-300 to-transparent hidden md:block"></div>
                  <div className="absolute left-6 h-full w-0.5 bg-gradient-to-b from-gray-300 to-transparent md:hidden"></div>
                  <div className="flex flex-col gap-12 md:gap-24 relative">
                    {sortedEvents.map((event, index) => (
                      <div key={event.id} id={`event-${event.id}`}>
                        <EventCard event={event} align={index % 2 === 0 ? 'left' : 'right'} onDelete={handleDeleteEvent} onEdit={(e) => { setEditingEvent(e); setIsEditorOpen(true); }} language={language} />
                      </div>
                    ))}
                  </div>
                </div>
              </main>

              <EventEditor isOpen={isEditorOpen} onClose={() => setIsEditorOpen(false)} onSave={handleSaveEvent} initialData={editingEvent} />

              <footer className="bg-white border-t border-gray-200 py-12 text-center">
                 <h3 className="font-serif text-2xl text-cobalt font-bold mb-4">{language === 'zh' ? '瓷器编年史' : 'Cíqì Chronicles'}</h3>
                 <button onClick={() => { if(confirm('Reset?')) { setEvents(INITIAL_EVENTS); localStorage.removeItem('ciqi-timeline-data'); window.history.pushState({}, '', window.location.pathname); } }} className="flex items-center gap-2 text-xs text-gray-400 hover:text-red-500 mx-auto uppercase tracking-widest mt-4">
                    <RotateCcw size={12} /> Reset Data
                 </button>
              </footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>